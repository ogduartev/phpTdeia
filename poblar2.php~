<?php
require_once("fuzzy_number.php");
require_once("importance.php");
require_once("aggregation.php");

class poblar
{
  function conectar()
  {
   if($link=mysql_connect("localhost","root","rootpassword"))
    {
      $sql="USE `tdeia`;";
      if(!mysql_query($sql))
      {
        echo "No existe la base de datos ".$this->base;
        return $link;
      }
    }else
    {
      return FALSE;
    }
    return $link;
  }
  
  function users()
  {
    $sql="DELETE FROM users";
    mysql_query($sql) or die(mysql_error()."error : ".$sql);

    $sql="INSERT INTO users(email_address,password,active,created,modified) VALUES ('ogduartev@gmail.com',password('password'),1,now(),now())";
    mysql_query($sql) or die(mysql_error()."error : ".$sql);
    $user_id_1=mysql_insert_id();

    $sql="DELETE FROM groups";
    mysql_query($sql) or die(mysql_error()."error : ".$sql);
    $sql="INSERT INTO groups(name,created,modified) VALUES ('administrador',now(),now())";
    mysql_query($sql) or die(mysql_error()."error : ".$sql);
    $group_id_1=mysql_insert_id();
    $sql="INSERT INTO groups(name,created,modified) VALUES ('visitante',now(),now())";
    mysql_query($sql) or die(mysql_error()."error : ".$sql);
    $group_id_2=mysql_insert_id();

    $sql="DELETE FROM groups_users";
    mysql_query($sql) or die(mysql_error()."error : ".$sql);
    $sql="INSERT INTO groups_users(group_id,user_id) VALUES (".$group_id_1.",".$user_id_1.")";
    mysql_query($sql) or die(mysql_error()."error : ".$sql);
    $sql="INSERT INTO groups_users(group_id,user_id) VALUES (".$group_id_2.",".$user_id_1.")";
    mysql_query($sql) or die(mysql_error()."error : ".$sql);

    $sql="DELETE FROM permissions";
    mysql_query($sql) or die(mysql_error()."error : ".$sql);
    $sql="INSERT INTO permissions(name,created,modified) VALUES ('crear',now(),now())";
    mysql_query($sql) or die(mysql_error()."error : ".$sql);
    $permission_id_1=mysql_insert_id();
    $sql="INSERT INTO permissions(name,created,modified) VALUES ('borrar',now(),now())";
    mysql_query($sql) or die(mysql_error()."error : ".$sql);
    $permission_id_2=mysql_insert_id();
    $sql="INSERT INTO permissions(name,created,modified) VALUES ('actualizar',now(),now())";
    mysql_query($sql) or die(mysql_error()."error : ".$sql);
    $permission_id_3=mysql_insert_id();
    $sql="INSERT INTO permissions(name,created,modified) VALUES ('ver',now(),now())";
    mysql_query($sql) or die(mysql_error()."error : ".$sql);
    $permission_id_4=mysql_insert_id();

    $sql="DELETE FROM groups_permissions";
    mysql_query($sql) or die(mysql_error()."error : ".$sql);
    $sql="INSERT INTO groups_permissions(group_id,permission_id) VALUES (".$group_id_1.",".$permission_id_1.")";
    mysql_query($sql) or die(mysql_error()."error : ".$sql);
    $sql="INSERT INTO groups_permissions(group_id,permission_id) VALUES (".$group_id_1.",".$permission_id_2.")";
    mysql_query($sql) or die(mysql_error()."error : ".$sql);
    $sql="INSERT INTO groups_permissions(group_id,permission_id) VALUES (".$group_id_1.",".$permission_id_3.")";
    mysql_query($sql) or die(mysql_error()."error : ".$sql);
    $sql="INSERT INTO groups_permissions(group_id,permission_id) VALUES (".$group_id_1.",".$permission_id_4.")";
    mysql_query($sql) or die(mysql_error()."error : ".$sql);
    $sql="INSERT INTO groups_permissions(group_id,permission_id) VALUES (".$group_id_2.",".$permission_id_4.")";
    mysql_query($sql) or die(mysql_error()."error : ".$sql);
  }
  
  function projects()
  {
    $sql="DELETE FROM projects";
    mysql_query($sql) or die(mysql_error()."error : ".$sql);
    $sql="INSERT INTO projects(name,description,created,modified) VALUES ('Proyecto de prueba','una descripción extensa...',now(),now())";
    mysql_query($sql) or die(mysql_error()."error : ".$sql);
    $project_id_1=mysql_insert_id();
    
    $sql="SELECT id FROM users";
    $result=mysql_query($sql) or die(mysql_error()."error : ".$sql);
    if($result and mysql_num_rows($result)>0)
    {
      while($linea=mysql_fetch_array($result,MYSQL_ASSOC))
      {
        $sql2="INSERT INTO projects_users(project_id,user_id) VALUES(".$project_id_1.",".$linea['id'].")";
        mysql_query($sql2) or die(mysql_error()."error : ".$sql2);
      }
    }
  }

  function actions($project_id)
  {
    $sql="DELETE FROM actions";
    mysql_query($sql) or die(mysql_error()."error : ".$sql);
    for($i=0;$i<1;$i++)
    {
      $nombre1="action ".($i+1).".";
      $sql1="INSERT INTO actions(name,description,level,project_id) VALUE('".$nombre1."','descripción',0,".$project_id.")";
      mysql_query($sql1) or die(mysql_error()."error : ".$sql1);
      $id1=mysql_insert_id();
      for($j=0;$j<3;$j++)
      {
        $nombre2=$nombre1.($j+1).".";
        $sql2="INSERT INTO actions(name,description,level,project_id,action_id) VALUE('".$nombre2."','descripción',1,".$project_id.",'".$id1."')";
        mysql_query($sql2) or die(mysql_error()."error : ".$sql2);
        $id2=mysql_insert_id();
        for($k=0;$k<3;$k++)
        {
          $nombre3=$nombre2.($k+1).".";
          $sql3="INSERT INTO actions(name,description,level,project_id,action_id) VALUE('".$nombre3."','descripción',2,".$project_id.",'".$id2."')";
          mysql_query($sql3) or die(mysql_error()."error : ".$sql3);
        }
      }
    }
  }

  function factors($project_id)
  {
    $sql="DELETE FROM factors";
    mysql_query($sql) or die(mysql_error()."error : ".$sql);
    for($i=0;$i<1;$i++)
    {
      $nombre1="factor ".($i+1).".";
      $sql1="INSERT INTO factors(name,description,level,weight,project_id) VALUE('".$nombre1."','descripción',0,1.0,".$project_id.")";
      mysql_query($sql1) or die(mysql_error()."error : ".$sql1);
      $id1=mysql_insert_id();
      for($j=0;$j<3;$j++)
      {
        $nombre2=$nombre1.($j+1).".";
        $sql2="INSERT INTO factors(name,description,level,weight,project_id,factor_id) VALUE('".$nombre2."','descripción',1,0.25,".$project_id.",'".$id1."')";
        mysql_query($sql2) or die(mysql_error()."error : ".$sql2);
        $id2=mysql_insert_id();
        for($k=0;$k<3;$k++)
        {
          $nombre3=$nombre2.($k+1).".";
          $sql3="INSERT INTO factors(name,description,level,weight,project_id,factor_id) VALUE('".$nombre3."','descripción',2,0.25,".$project_id.",'".$id2."')";
          mysql_query($sql3) or die(mysql_error()."error : ".$sql3);
        }
      }
    }
  }

  function effect_propierties($project_id)
  {
    $sql="DELETE FROM effect_propierties";
    mysql_query($sql) or die(mysql_error()."error : ".$sql);
    $propierties=array();
    $propierties[]=array("name"=>"Propiedad 1","description"=>"Descripción...","nature"=>1,"weight"=>"0.25","theta"=>2);
    $propierties[]=array("name"=>"Propiedad 2","description"=>"Descripción...","nature"=>1,"weight"=>"0.25","theta"=>2);
    $propierties[]=array("name"=>"Propiedad 3","description"=>"Descripción...","nature"=>1,"weight"=>"0.25","theta"=>2);
    $propierties[]=array("name"=>"Propiedad 4","description"=>"Descripción...","nature"=>1,"weight"=>"0.25","theta"=>2);
    foreach($propierties as $p)
    {
      $variable_id=$this->variable($p['name'],0,1,array("muy bajo","bajo","medio","alto","muy alto"));
      $sql="INSERT INTO effect_propierties(";
      foreach($p as $k=>$v){$sql.=$k.",";}
      $sql.="variable_id,project_id) VALUES ('";
      foreach($p as $k=>$v){$sql.=$v."','";}
      $sql.=$variable_id."','".$project_id."')";
      mysql_query($sql) or die(mysql_error()."error : ".$sql);
    }
  }
  
  function variable($name,$min,$max,$labels)
  {
    if(count($labels)<2) return 0;
    
    $sql="INSERT INTO variables(name,description,minimum,maximum) VALUES('".$name."','description...',".$min.",".$max.")";
    mysql_query($sql) or die(mysql_error()."error : ".$sql);
    $variable_id=mysql_insert_id();
    $cnt=count($labels);
    $dx=($max-$min)/(2*$cnt-1);
    $sql="INSERT INTO sets(label,variable_id) VALUES('".$labels[0]."','".$variable_id."')";
    mysql_query($sql) or die(mysql_error()."error : ".$sql);
    $set_id=mysql_insert_id();
    $FN=new fuzzy_number();
    $FN->trapezoid($min,$min,$dx,2*$dx);
    $FN->write("cuts","set_id",$set_id);  
    for($i=1;$i<($cnt-1);$i++)
    {
      $sql="INSERT INTO sets(label,variable_id) VALUES('".$labels[$i]."','".$variable_id."')";
      mysql_query($sql) or die(mysql_error()."error : ".$sql);
      $set_id=mysql_insert_id();
      $FN=new fuzzy_number();
      $FN->trapezoid((2*$i-1)*$dx,(2*$i)*$dx,(2*$i+1)*$dx,(2*$i+2)*$dx);
      $FN->write("cuts","set_id",$set_id);  
    }
    $sql="INSERT INTO sets(label,variable_id) VALUES('".$labels[$cnt-1]."','".$variable_id."')";
    mysql_query($sql) or die(mysql_error()."error : ".$sql);
    $set_id=mysql_insert_id();
    $FN=new fuzzy_number();
    $FN->trapezoid((2*$cnt-3)*$dx,(2*$cnt-2)*$dx,$max,$max);
    $FN->write("cuts","set_id",$set_id);  
    $set_id=0;
    $sql="SELECT id FROM sets WHERE variable_id=".$variable_id." LIMIT 1";
    $result=mysql_query($sql) or die(mysql_error()."error : ".$sql);
    if($result and mysql_num_rows($result)>0)
    {
      $linea=mysql_fetch_array($result,MYSQL_ASSOC);
      $set_id=$linea['id'];
    }
    $input_id=$this->input(0,1,$set_id);
    $sql="UPDATE variables SET default_input_id=".$input_id." WHERE id=".$variable_id;
    mysql_query($sql) or die(mysql_error()."error : ".$sql);
    return $variable_id;
  }

  function input($min,$max,$set_id)
  {
    $crisp=($min+$max)*(0.5);
    $L=($min+$max)*(0.2);
    $R=($min+$max)*(0.6);
    $str="";$str.=$crisp;$crisp=str_replace(",",".",$str);
    $str="";$str.=$L;$L=str_replace(",",".",$str);
    $str="";$str.=$R;$R=str_replace(",",".",$str);    
    $sql="INSERT INTO inputs(description,nature,type,crisp,L,R,set_id,modifier) VALUES('description...',1,2,".$crisp.",".$L.",".$R.",".$set_id.",1)";
    mysql_query($sql) or die(mysql_error()."error : ".$sql);
    $input_id=mysql_insert_id();
    $a=($min+$max)*(0.35);
    $b=($min+$max)*(0.45);
    $c=($min+$max)*(0.55);
    $d=($min+$max)*(0.65);
    $FN=new fuzzy_number();
    $FN->trapezoid($a,$b,$c,$d);
    $FN->write("input_cuts","input_id",$input_id);  
    return $input_id;
  }
  
  function effects($project_id,$cuts)
  {
    $sql="DELETE FROM effects";
    mysql_query($sql) or die(mysql_error()."error : ".$sql);
    $sql="DELETE FROM importances";
    mysql_query($sql) or die(mysql_error()."error : ".$sql);
    $sql="DELETE FROM aggregations";
    mysql_query($sql) or die(mysql_error()."error : ".$sql);

    $max_actions=0;
    $sql="SELECT max(level) as l FROM actions WHERE project_id=".$project_id;
    $result=mysql_query($sql) or die(mysql_error()."error : ".$sql);
    if($result and mysql_num_rows($result)>0)
    {
      $linea=mysql_fetch_array($result,MYSQL_ASSOC);
      $max_actions=$linea['l'];
    }

    $max_factors=0;
    $sql="SELECT max(level) as l FROM factors WHERE project_id=".$project_id;
    $result=mysql_query($sql) or die(mysql_error()."error : ".$sql);
    if($result and mysql_num_rows($result)>0)
    {
      $linea=mysql_fetch_array($result,MYSQL_ASSOC);
      $max_factors=$linea['l'];
    }
    
    $sql ="SELECT actions.id AS AID,factors.id AS FID, actions.name AS ANM, factors.name AS FNM
                  FROM actions JOIN projects ON actions.project_id=projects.id 
                               JOIN factors ON projects.id=factors.project_id 
                               WHERE actions.level=".$max_actions." AND factors.level=".$max_factors;
    $result=mysql_query($sql) or die(mysql_error()."error : ".$sql);
    if($result and mysql_num_rows($result)>0)
    {
      while($linea=mysql_fetch_array($result,MYSQL_ASSOC))
      {
        $action_id=$linea['AID'];
        $factor_id=$linea['FID'];
        $action_name=$linea['ANM'];
        $factor_name=$linea['FNM'];
        $this->single_effect($action_id,$factor_id,$action_name,$factor_name,$project_id,$cuts);
      }
    }
  }
  
  function single_effect($action_id,$factor_id,$action_name,$factor_name,$project_id,$cuts)
  {
    $name="Efecto ".$action_id."-".$factor_id;
    echo $name."\n";
    $description="Efecto de la acción \"".$action_name."\" sobre el factor \"".$factor_name."\"";
    $sql="INSERT INTO effects(name,description,project_id,factor_id,action_id) VALUES('".$name."','".$description."',".$project_id.",".$factor_id.",".$action_id.")";
    $result=mysql_query($sql) or die(mysql_error()."error : ".$sql);
    $effect_id=mysql_insert_id();
    $this->propierties($effect_id,$project_id);
    $I=new importance();
    $name="Importancia ".$effect_id;
        echo $name."\n";
    $I->insert_single_importance($project_id,$effect_id,$cuts);
    //// Aggregations
    $aggregators=array();
    $sql ="SELECT id,equation FROM aggregators WHERE project_id=".$project_id." AND importance=0";
    $result=mysql_query($sql) or die(mysql_error()."error : ".$sql);
    if($result and mysql_num_rows($result)>0)
    {
      while($linea=mysql_fetch_array($result,MYSQL_ASSOC))
      {
        $aggregators[]=array("id"=>$linea['id'],"equation"=>$linea['equation']);
      }
    }
    
    $factorParents=$I->findUp($factor_id,"factor");
    $actionParents=$I->findUp($action_id,"action");
    foreach($factorParents as $f_id)
    {
      foreach($actionParents as $a_id)
      {
        foreach($aggregators as $agg)
        {
          echo "AGG: ".$agg['id']." ";
          $aggregator=new weighted_importance();
          switch($agg['equation'])
          {
            case 0: 
                   $aggregator=new weighted_importance();
                   break;
          }
          $aggregator->insert_single_aggregation($agg['id'],$f_id,$a_id,$cuts);        
        }
        echo "\n";
      }
    }
  }
  
  function propierties($effect_id,$project_id)
  {
    $sql="SELECT id,variable_id FROM effect_propierties WHERE project_id=".$project_id;//echo "\n\n".$sql."\n\n";
    $result=mysql_query($sql) or die(mysql_error()."error : ".$sql);
    if($result and mysql_num_rows($result)>0)
    {
      while($linea=mysql_fetch_array($result,MYSQL_ASSOC))
      {
        $effect_propierty_id=$linea['id'];

        $set_id=0;
        $sql2="SELECT id FROM sets WHERE variable_id=".$linea['variable_id']." LIMIT 1";
        $result2=mysql_query($sql2) or die(mysql_error()."error : ".$sql2);
        if($result2 and mysql_num_rows($result2)>0)
        {
          $linea2=mysql_fetch_array($result2,MYSQL_ASSOC);
          $set_id=$linea2['id'];
        }
        $input_id=$this->input(0,1,$set_id);

        $sql="INSERT INTO propierties(effect_id,effect_propierty_id,input_id) VALUES(".$effect_id.",".$effect_propierty_id.",".$input_id.")";
        mysql_query($sql) or die(mysql_error()."error : ".$sql);
      }
    }
  }

  function aggregators($project_id)
  {
    $sql="DELETE FROM aggregators";
    mysql_query($sql) or die(mysql_error()."error : ".$sql);
    $aggregators[]=array("name"=>"Importance",         "description"=>"Descripción...","importance"=>1,"equation"=>"linear_combination");
    $aggregators[]=array("name"=>"Medium importance",  "description"=>"Descripción...","importance"=>0,"equation"=>"linear_combination");
    $aggregators[]=array("name"=>"Weighted importance","description"=>"Descripción...","importance"=>0,"equation"=>"linear_combination");
    $aggregators[]=array("name"=>"Maximum importance", "description"=>"Descripción...","importance"=>0,"equation"=>"linear_combination");
    foreach($aggregators as $p)
    {
      $variable_id=$this->variable($p['name'],0,1,array("muy bajo","bajo","medio","alto","muy alto"));
      $sql="INSERT INTO aggregators(";
      foreach($p as $k=>$v){$sql.=$k.",";}
      $sql.="variable_id,project_id) VALUES ('";
      foreach($p as $k=>$v){$sql.=$v."','";}
      $sql.=$variable_id."','".$project_id."')";
      mysql_query($sql) or die(mysql_error()."error : ".$sql);
    }
  }
  
  function importances($project_id,$cuts)
  {
    $sql="DELETE FROM importances";
    mysql_query($sql) or die(mysql_error()."error : ".$sql);
    $sql ="SELECT id FROM effects WHERE project_id=".$project_id;
    $result=mysql_query($sql) or die(mysql_error()."error : ".$sql);
    if($result and mysql_num_rows($result)>0)
    {
      while($linea=mysql_fetch_array($result,MYSQL_ASSOC))
      {
        $I=new importance();
        $name="Importancia ".$linea['id'];
        echo $name."\n";
        $Imp=$I->insert_single_importance($project_id,$linea['id'],$cuts);
      }
    }
  }

}

$P=new poblar();
$cuts=3;
if($P->conectar())
{
/*
  $P->users();
  $P->projects();
  $sql="SELECT id FROM projects";
  $result=mysql_query($sql) or die(mysql_error()."error : ".$sql);
  if($result and mysql_num_rows($result)>0)
  {
    while($linea=mysql_fetch_array($result,MYSQL_ASSOC))
    {
      echo "Acciones ".date(" G:i:s")."\n";
      $P->actions($linea['id']);
      echo "Factores ".date(" G:i:s")."\n";
      $P->factors($linea['id']);
      echo "Propiedades ".date(" G:i:s")."\n";
      $P->effect_propierties($linea['id']);
      echo "Aggregaciones ".date(" G:i:s")."\n";
      $P->aggregators($linea['id']);
      echo "Efectos ".date(" G:i:s")."\n";
      $P->effects($linea['id'],$cuts);
      echo "Fin ".date(" G:i:s")."\n";
    }
  }
*/

  $I=new importance();
  $I->insert_single_importance(1,1,3);
  
}

?>
