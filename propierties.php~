<?php

class propierty
{
  function conectar()
  {
   if($link=mysql_connect("localhost","root","rootpassword"))
    {
      $sql="USE `tdeia`;";
      if(!mysql_query($sql))
      {
        echo "No existe la base de datos ".$this->base;
        return $link;
      }
    }else
    {
      return FALSE;
    }
    return $link;
  }

  function projectExists($project_id)
  {
    $sql="SELECT * FROM projects WHERE id='".$project_id."'";
    $result=mysql_query($sql) or die(mysql_error()."error : ".$sql);
    if($result and mysql_num_rows($result)>0)
    {
      return true;
    }
    return false;
  }
  
  function importEffectPropiertiesCSV($project_id,$fn,$flagDelete='true')
  {
    $table="effect_propierties";
    if(!$this->projectExists($project_id))
    {
      $sql="INSERT INTO projects(name,description,created,modified) VALUES ('Proyecto de prueba CSV','una descripción extensa...',now(),now())";
      mysql_query($sql) or die(mysql_error()."error : ".$sql);
      $project_id=mysql_insert_id();
    }
    if($flagDelete)
    {
      $sql="DELETE FROM ".$table." WHERE project_id='".$project_id."'";
      mysql_query($sql) or die(mysql_error()."error : ".$sql);
    }
  
    $f=file($fn);
    $f=array_slice($f,1);
    foreach ($f as $linea)
    {
      $linea=str_replace("\n","",$linea);
      $datos=explode("\t",$linea);
      $nombre=$datos[0];
      $descripcion=$datos[1];
      $naturaleza=$datos[2];
      $peso=$datos[3];
      $teta=$datos[4];
      $min=$datos[5];
      $max=$datos[6];
      $datos=array_slice($datos,7);
      $tam=count($datos);
      for($i=$tam-1;$i>=0;$i--)
      {
        if($datos[$i]==""){unset($datos[$i]);}
      }
      $tam=count($datos);
      $et=(int)($tam/5);
      $etiquetas=array();
      for($i=0;$i<$et;$i++)
      {
        $label=$datos[$i*5 + 0];
        $l0=$datos[$i*5 + 1];
        $r0=$datos[$i*5 + 2];
        $l1=$datos[$i*5 + 3];
        $r1=$datos[$i*5 + 3];
        $set=array("label"=>$label,"L0"=>$l0,"R0"=>$r0,"L1"=>$l1,"R1"=>$r1);
        $etiquetas[]=$set;
      }
      
      $sql="INSERT INTO variables(name,description,minimum,maximum) VALUES('".$nombre."','".$descripcion."','".$min."','".$max."')";
      mysql_query($sql) or die(mysql_error()."error : ".$sql);
      $variable_id=mysql_insert_id();
      
      $sql="INSERT INTO ".$table."(name,description,nature,weight,theta,variable_id,project_id) 
                            VALUES('".$nombre."','".$descripcion."','".$naturaleza."','".$peso."','".$teta."','".$variable_id."','".$project_id."')";
      mysql_query($sql) or die(mysql_error()."error : ".$sql);
      $eff_pro_id=mysql_insert_id();
      
      foreach($etiquetas as $et)
      {
        $sql="INSERT INTO sets(label,variable_id) VALUES('".$et['label']."','".$variable_id."')";
        mysql_query($sql) or die(mysql_error()."error : ".$sql);
        $set_id=mysql_insert_id();
        
        $sql="INSERT INTO cuts(alpha,L,R,set_id) VALUES('0.0','".$et['L0']."','".$et['R0']."','".$set_id."')";
        mysql_query($sql) or die(mysql_error()."error : ".$sql);
        $sql="INSERT INTO cuts(alpha,L,R,set_id) VALUES('1.0','".$et['L1']."','".$et['R1']."','".$set_id."')";
        mysql_query($sql) or die(mysql_error()."error : ".$sql);       
      }
      
      $sql="INSERT INTO inputs(description,nature,type,crisp,L,R,modifier,set_id) 
                        VALUES('".$descripcion."','".$naturaleza."','2','".(0.5*($min+$max))."','".$min."','".$max."','1','".$set_id."')";
      mysql_query($sql) or die(mysql_error()."error : ".$sql);
      $input_id=mysql_insert_id();
       
      $sql="INSERT INTO input_cuts(alpha,L,R,input_id) VALUES('0.0','".$min."','".$max."','".$input_id."')";
      mysql_query($sql) or die(mysql_error()."error : ".$sql);
      $sql="INSERT INTO input_cuts(alpha,L,R,input_id) VALUES('1.0','".$min."','".$max."','".$input_id."')";
      mysql_query($sql) or die(mysql_error()."error : ".$sql);       
      
      $sql="UPDATE variables SET default_input_id='".$input_id."' WHERE id='".$variable_id."'";
      mysql_query($sql) or die(mysql_error()."error : ".$sql);       
      
    }
  }
  
  function find_id($project_id,$table,$col,$value,$flagProject=true)
  {
    $sql="SELECT id FROM ".$table." WHERE ".$col."='".$value."' ";
    if($flagProject)
    {
      $sql.="AND project_id='".$project_id."'";
    }
    $result=mysql_query($sql) or die(mysql_error()."error : ".$sql);
    if($result and mysql_num_rows($result)>0)
    {
      $linea=mysql_fetch_array($result,MYSQL_ASSOC);
      return $linea['id'];
    }
    return 0;
  }

  function importEffectsCSV($project_id,$dir,$fn,$flagDelete='true')
  {
    $table="effect_propierties";
    if(!$this->projectExists($project_id))
    {
      $sql="INSERT INTO projects(name,description,created,modified) VALUES ('Proyecto de prueba CSV','una descripción extensa...',now(),now())";
      mysql_query($sql) or die(mysql_error()."error : ".$sql);
      $project_id=mysql_insert_id();
    }
    if($flagDelete)
    {
      $sql="DELETE FROM effects WHERE project_id='".$project_id."'";
      mysql_query($sql) or die(mysql_error()."error : ".$sql);
    }
    
    $f=file($fn);
    $accionesId=array();
    $accionesName=array();
    $acciones=explode("\t",str_replace("\n","",$f[0]));
    foreach($acciones as $K=>$a)
    {
      $accionesId[$K]=$this->find_id($project_id,"actions","name",$a);
      $accionesName[$accionesId[$K]]=$a;
    }
    $tam=count($f);
    $efectos=array();
    $factoresName=array();
    for($i=1;$i<$tam;$i++)
    {
      $datos=explode("\t",str_replace("\n","",$f[$i]));
      $factor=$this->find_id($project_id,"factors","name",$datos[0]);
      $factoresName[$factor]=$datos[0];
      $efectosFactor=array();
      $tam2=count($datos);
      for($j=1;$j<$tam2;$j++)
      {
        if(strlen($datos[$j])>0)
        {
          $efectosFactor[]=$accionesId[$j];
        }
      }
      $efectos[$factor]=$efectosFactor;
    }
    
    $efProp=array();
    $sql="SELECT id,name FROM effect_propierties WHERE project_id='".$project_id."'";
    $result=mysql_query($sql) or die(mysql_error()."error : ".$sql);
    if($result and mysql_num_rows($result)>0)
    {
      while($linea=mysql_fetch_array($result,MYSQL_ASSOC))
      {
        $efProp[$linea['id']]=$linea['name'];
      }
    }
    
    foreach($efectos as $factor_id=>$efs)
    {
      foreach($efs as $action_id)
      {
        // crear efecto
        $sql="INSERT INTO effects(project_id,action_id,factor_id,name,description)
                           VALUES('".$project_id."','".$action_id."','".$factor_id."',
                           '".($factoresName[$factor_id]."-".$accionesName[$action_id])."','Sin descripción')";
        $result=mysql_query($sql) or die(mysql_error()."error : ".$sql);
        $effect_id=mysql_insert_id();
        foreach($efProp as $ef_prop_id=>$ef_name)
        {
          // leer el archivo y traer el valor y crear la propiedad
          $this->readSinglePropierty($dir.$ef_name.".csv",$project_id,$factor_id,$action_id,$ef_prop_id,$effect_id);
        }
      }
    }
  }
  
  function readSinglePropierty($fn,$project_id,$factor_id,$action_id,$eff_prop_id,$effect_id)
  {
    $f=file($fn);
    $accionesId=array();
    $acciones=explode("\t",str_replace("\n","",$f[0]));
    foreach($acciones as $K=>$a)
    {
      $accionesId[$K]=$this->find_id($project_id,"actions","name",$a);
    }
    $tam=count($f);
    $efectos=array();
    for($i=1;$i<$tam;$i++)
    {
      $datos=explode("\t",str_replace("\n","",$f[$i]));
      $factor=$this->find_id($project_id,"factors","name",$datos[0]);
      $efectosFactor=array();
      $tam2=count($datos);
      for($j=1;$j<$tam2;$j++)
      {
        if(strlen($datos[$j])>0)
        {
          $efectosFactor[$accionesId[$j]]=$datos[$j];
        }
      }
      $efectos[$factor]=$efectosFactor;
    }
    $PropName= $efectos[$factor_id][$action_id];    
    $sql="SELECT sets.id AS I,variables.name AS N,variables.description AS D,effect_propierties.nature as NA,variables.minimum AS MN,variables.maximum AS MX FROM sets
                         INNER JOIN variables ON variables.id=sets.variable_id
                         INNER JOIN effect_propierties ON effect_propierties.variable_id=variables.id
                         WHERE effect_propierties.id='".$eff_prop_id."'
                         AND project_id='".$project_id."'
                         AND sets.label='".$PropName."'";
    $result=mysql_query($sql) or die(mysql_error()."error : ".$sql);
    if($result and mysql_num_rows($result)>0)
    {
      $linea=mysql_fetch_array($result,MYSQL_ASSOC);
      $set_id=$linea['I'];
      
      // OJO: revisar tipo de entrada!!!
      
      $sql2="INSERT INTO inputs(description,nature,type,crisp,L,R,modifier,set_id) 
                        VALUES('".$linea['D']."','".$linea['NA']."','2','".(0.5*($linea['MN']+$linea['MX']))."','".$linea['MN']."','".$linea['MX']."','1','".$set_id."')";
      mysql_query($sql2) or die(mysql_error()."error : ".$sql2);
      $input_id=mysql_insert_id();
       
      $sql2="INSERT INTO input_cuts(alpha,L,R,input_id) VALUES('0.0','".$linea['MN']."','".$linea['MX']."','".$input_id."')";
      mysql_query($sql2) or die(mysql_error()."error : ".$sql2);
      $sql2="INSERT INTO input_cuts(alpha,L,R,input_id) VALUES('1.0','".$linea['MN']."','".$linea['MX']."','".$input_id."')";
      mysql_query($sql2) or die(mysql_error()."error : ".$sql2);       
      
      $sql2="INSERT INTO propierties(effect_id,effect_propierty_id,input_id)
                         VALUES('".$effect_id."','".$eff_prop_id."','".$input_id."')";
      mysql_query($sql2) or die(mysql_error()."error : ".$sql2);             
    }
    
  }
  
}

$dir="/home/ogduartev/public_html/phpTdeia/";
$P=new propierty;
if($P->conectar())
{
//  $P->importEffectPropiertiesCSV(3,$dir."datos/propiedades.csv",false);
  $P->importEffectsCSV(3,$dir."datos/",$dir."datos/Efectos.csv",false);
}

?>
